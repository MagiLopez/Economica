{% extends "base.html" %}

{% block title %}Amortizaci√≥n{% endblock %}

{% block content %}
<div class="container">
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üìä Amortizaci√≥n</h1>
        <span class="user-info">{{ username }}</span>
    </div>

    <!-- Secci√≥n de Teor√≠a Colapsable -->
    <div class="teoria-section">
        <button class="teoria-toggle" type="button" id="teoriaBtn">
            <span id="teoriaIcon">‚ñ∂</span> Teor√≠a: ¬øQu√© es la Amortizaci√≥n?
        </button>
        <div class="teoria-content" id="teoriaContent">
            <h3>üí° ¬øQu√© es la amortizaci√≥n?</h3>
            <p>La <strong>amortizaci√≥n</strong> consiste en el pago gradual de una deuda mediante
            <strong>cuotas peri√≥dicas</strong>. Cada cuota incluye una parte de
            <strong>capital</strong> (que reduce la deuda) y otra de
            <strong>intereses</strong> (que es el costo del pr√©stamo).
            </p>
            <h4>üìò M√©todos de amortizaci√≥n:</h4>

            <!-- SISTEMA FRANC√âS -->
            <div class="teoria-box" style="background-color:#f0f7ff; border-radius:10px; padding:15px; margin-bottom:15px;">
            <h4>üîπ Sistema Franc√©s</h4>
            <p>
                Cuotas <strong>constantes</strong>, amortizaci√≥n <strong>creciente</strong> e intereses
                <strong>decrecientes</strong>. Es el sistema m√°s com√∫n en pr√©stamos bancarios.
            </p>
            <p><strong>F√≥rmula:</strong></p>
            <p style="text-align:center;">
                <code>C = P √ó [i √ó (1 + i)‚Åø] / [(1 + i)‚Åø - 1]</code>
            </p>
            <p><strong>Donde:</strong><br>
                C = Cuota<br>
                P = Capital inicial<br>
                r = Tasa de inter√©s por per√≠odo<br>
                n = N√∫mero de per√≠odos
            </p>
            </div>

            <!-- SISTEMA ALEM√ÅN -->
            <div class="teoria-box" style="background-color:#f6f0ff; border-radius:10px; padding:15px; margin-bottom:15px;">
            <h4>üîπ Sistema Alem√°n</h4>
            <p>
                Amortizaci√≥n <strong>constante</strong> y cuotas <strong>decrecientes</strong>,
                ya que los intereses disminuyen a medida que se paga el capital.
            </p>
            <p><strong>F√≥rmula:</strong></p>
            <p style="text-align:center;">
                <code>A = P / n</code>
            </p>
            <p><strong>Donde:</strong><br>
                A = Amortizaci√≥n constante<br>
                P = Capital inicial<br>
                n = N√∫mero de per√≠odos
            </p>
            <p><strong>Cuota:</strong></p>
            <p style="text-align:center;">
                <code>C = A + (Saldo √ó r)</code>
            </p>
            </div>

            <!-- SISTEMA AMERICANO / INGL√âS -->
            <div class="teoria-box" style="background-color:#e9f5ff; border-radius:10px; padding:15px;">
            <h4>üîπ Sistema Americano</h4>
            <p>
                Durante el plazo del pr√©stamo solo se pagan los <strong>intereses peri√≥dicos</strong>,
                y el <strong>capital se cancela al final</strong> del per√≠odo.
            </p>
            <p><strong>F√≥rmula:</strong></p>
            <p style="text-align:center;">
                <code>I = P √ó r</code>
            </p>
            <p><strong>Donde:</strong><br>
                I = Inter√©s peri√≥dico<br>
                P = Capital inicial<br>
                r = Tasa de inter√©s por per√≠odo
            </p>
            <p><strong>En el √∫ltimo per√≠odo:</strong></p>
            <p style="text-align:center;">
                <code>Pago = I + P</code>
            </p>
            <p style="text-align:center; color:#555; font-size:0.9em;">
                (inter√©s + capital total)
            </p>
            </div>
            
        </div>
    </div>

    <p>Completa los campos requeridos para generar la tabla de amortizaci√≥n. El c√°lculo se realizar√° cuando est√© disponible la conexi√≥n.</p>

    <form id="amortizacionForm">
        <div class="input-row">
            <div class="input-group">
                <label for="capital">Capital (P):</label>
                <input type="number" id="capital" name="capital" step="0.01">
                <small>Monto del pr√©stamo</small>
            </div>

            <div class="input-group">
                <label for="tasa">Tasa de inter√©s (i):</label>
                <input type="number" id="tasa" name="tasa" step="0.01">
                <small>Por per√≠odo (%)</small>
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="n">N√∫mero de per√≠odos (n):</label>
                <input type="number" id="n" name="n">
                <small>Cantidad de cuotas</small>
            </div>

            <div class="input-group full-width">
                <label for="tipoAmortizacion">Sistema de Amortizaci√≥n:</label>
                <select id="tipoAmortizacion" name="tipoAmortizacion">
                    <option value="frances">Sistema Franc√©s </option>
                    <option value="aleman">Sistema Alem√°n </option>
                    <option value="americano">Sistema Americano</option>
                </select>
            </div>
        </div>

        <button type="button" class="btn" id="calcularBtn">üìã Generar Tabla de Amortizaci√≥n</button>
    </form>

    <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resumen:</h3>
            <div class="result-value" id="resultValue">‚Äî</div>
            <div class="result-detail" id="resultDetail">El resultado aparecer√° aqu√≠.</div>
        </div>
    </div>
    
    <!-- Tabla de Amortizaci√≥n -->
    <!-- TABLA AGREGADA AQU√ç -->
<div class="tabla-container" id="tablaContainer" style="margin-top: 20px;">
    <table id="tablaAmortizacion" style="width: 100%; border-collapse: collapse;">
        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <tr>
                <th style="padding: 12px; text-align: right;">Per√≠odo</th>
                <th style="padding: 12px; text-align: right;">Cuota</th>
                <th style="padding: 12px; text-align: right;">Inter√©s</th>
                <th style="padding: 12px; text-align: right;">Amortizaci√≥n</th>
                <th style="padding: 12px; text-align: right;">Saldo</th>
            </tr>
        </thead>
        <tbody id="tablaBody">
        </tbody>
    </table>
</div>




</div>



<script>
    // Mostrar/ocultar teor√≠a
    document.getElementById('teoriaBtn').addEventListener('click', function() {
        const content = document.getElementById('teoriaContent');
        const icon = document.getElementById('teoriaIcon');
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    });

    // Conexi√≥n con el backend FastAPI
    document.getElementById('calcularBtn').addEventListener('click', async function() {
        const resultBox = document.getElementById('resultBox');
        const resultValue = document.getElementById('resultValue');
        const resultDetail = document.getElementById('resultDetail');
        const tablaAmortizacion = document.getElementById('tablaAmortizacion');

        // Obtener valores del formulario
        const capital = parseFloat(document.getElementById('capital').value);
        const tasa = parseFloat(document.getElementById('tasa').value);
        const n = parseInt(document.getElementById('n').value);
        const tipoAmortizacion = document.getElementById('tipoAmortizacion').value;

        // Validaci√≥n
        if (isNaN(capital) || isNaN(tasa) || isNaN(n)) {
            alert('Por favor, completa todos los campos correctamente');
            return;
        }

        // Solo ejecutar si es Sistema Americano
        if (tipoAmortizacion !== "americano") {
            alert("Selecciona el sistema americano para esta prueba.");
            return;
        }

        try {
            // Enviar los datos al backend
            const response = await fetch("http://127.0.0.1:8000/calcular_Amortizacion_Sistema_Americano", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    p: capital,
                    i: tasa,
                    n: n
                })
            });

            if (!response.ok) throw new Error("Error al obtener la amortizaci√≥n");

            const data = await response.json();

            // Mostrar resultados
            resultBox.classList.remove('hidden');
            resultValue.textContent = "C√°lculo completado con √©xito";
            resultDetail.textContent = "Tabla de amortizaci√≥n generada:";

            // Limpiar tabla anterior
            tablaAmortizacion.innerHTML = `
                <tr>
                    <th>Periodo</th>
                    <th>Inter√©s</th>
                    <th>Amortizaci√≥n</th>
                    <th>Saldo</th>
                </tr>
            `;

            // Rellenar tabla con los datos del backend
            data.tabla.forEach(fila => {
                const tr = document.createElement("tr");
                fila.forEach(valor => {
                    const td = document.createElement("td");
                    td.textContent = valor;
                    tr.appendChild(td);
                });
                tablaAmortizacion.appendChild(tr);
            });

        } catch (error) {
            console.error("Error:", error);
            alert("Ocurri√≥ un error al conectar con el servidor");
        }
    });
</script>


{% endblock %}