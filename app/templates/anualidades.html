{% extends "base.html" %}

{% block title %}Anualidades{% endblock %}

{% block content %}
<div class="container">
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üìÖ Anualidades</h1>
        <span class="user-info">{{ username }}</span>
    </div>
    
    <p>Completa exactamente <strong>4 campos</strong> y deja <strong>1 vac√≠o</strong>. El c√°lculo se realizar√° en el servidor.</p>

    <form id="anualidadesForm">
        <div class="input-row">
            <div class="input-group">
                <label for="renta">Renta (R):</label>
                <input type="number" id="renta" name="renta">
            </div>

            <div class="input-group">
                <label for="n">N√∫mero de per√≠odos (n):</label>
                <input type="number" id="n" name="n">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="tasa">Tasa de inter√©s (i):</label>
                <input type="number" id="tasa" name="tasa" step="0.01">
                <small> </small>
            </div>
        <div class="input-group full-width">
                <label for="calcular">¬øQu√© deseas calcular?</label>
                <select id="calcular" name="calcular">
                    <option value="vf">Valor Futuro (VF)</option>
                    <option value="va">Valor Presente (VA)</option>
                </select>
            </div>
           
        </div>

        <button type="submit" class="btn" id="calcularBtn"> Calcular</button>
    </form>

   <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resultado:</h3>
            <div class="result-value" id="resultValue">0</div>
            <div class="result-detail" id="resultDetail"></div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('anualidadesForm');
    const resultBox = document.getElementById('resultBox');
    const resultValue = document.getElementById('resultValue');
    const resultDetail = document.getElementById('resultDetail');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Obtener valores del formulario
        const renta = parseFloat(document.getElementById('renta').value);
        const n = parseFloat(document.getElementById('n').value);
        const tasa = parseFloat(document.getElementById('tasa').value);
        const calcular = document.getElementById('calcular').value;
        
        // Validar que todos los campos requeridos est√©n llenos
        if (isNaN(renta) || isNaN(n) || isNaN(tasa)) {
            alert('Por favor, completa todos los campos requeridos (Renta, Per√≠odos y Tasa)');
            return;
        }

        // Preparar datos seg√∫n lo que se quiere calcular
        let data = {
            A: renta,
            n: n,
            i: tasa
        };

        // Configurar qu√© campo dejar en 0 seg√∫n la selecci√≥n
        if (calcular === 'vf') {
            data.vf = 0;
            data.va = null;
        } else if (calcular === 'va') {
            data.va = 0;
            data.vf = null;
        }

        try {
            // Mostrar loading
            document.getElementById('calcularBtn').textContent = 'Calculando...';
            document.getElementById('calcularBtn').disabled = true;

            // Hacer petici√≥n al backend
            const response = await fetch('http://127.0.0.1:5000/calcular_Anualidad', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error en el c√°lculo');
            }

            const result = await response.json();
            
            // Mostrar resultado
            let calculatedValue;
            let resultText;
            
            if (result.vf !== undefined) {
                calculatedValue = result.vf;
                resultText = 'Valor Futuro';
            } else if (result.va !== undefined) {
                calculatedValue = result.va;
                resultText = 'Valor Presente';
            }

            resultValue.textContent = `$${calculatedValue.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            resultDetail.textContent = `${resultText} calculado con los par√°metros ingresados`;
            
            // Mostrar caja de resultado
            resultBox.classList.remove('hidden');
            
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            // Restaurar bot√≥n
            document.getElementById('calcularBtn').textContent = 'Calcular';
            document.getElementById('calcularBtn').disabled = false;
        }
    });
});
</script>

{% endblock %}
