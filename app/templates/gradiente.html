{% extends "base.html" %}

{% block title %}Gradientes{% endblock %}

{% block content %}
<div class="container">
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üìà Gradientes</h1>
        <span class="user-info">{{ username }}</span>
    </div>

    <!-- Secci√≥n de Teor√≠a Colapsable -->
    <div class="teoria-section">
        <button class="teoria-toggle" type="button" id="teoriaBtn">
            <span id="teoriaIcon">‚ñ∂</span> Teor√≠a: ¬øQu√© son los Gradientes?
        </button>
        <div class="teoria-content" id="teoriaContent">
            <h3>üí° Conceptos B√°sicos</h3>
            <p>Un <strong>Gradiente </strong> es una sucesi√≥n de pagos o ingresos que var√≠an de un per√≠odo a otro seg√∫n una regla establecida. Se utiliza en el an√°lisis financiero para representar flujos de efectivo no uniformes, es decir, que cambian a lo largo del tiempo.</p>

            <h4>Tipos de Gradientes:</h4>
            <div class="tipo-box">
                <strong>üîπ Gradiente Aritm√©tico:</strong> Los pagos aumentan o disminuyen en una cantidad constante (G).<br>
                <strong>üîπ Gradiente Geom√©trico:</strong> Los pagos cambian en un porcentaje constante por per√≠odo.<br>
                <strong>üîπ Series Variables:</strong> Pagos no uniformes sin patr√≥n definido.
            </div>

            <h4>F√≥rmulas Principales:</h4>
            <div class="formula-box">
                <strong>Valor Presente (VP) ‚Äî Gradiente Aritm√©tico:</strong><br>
                VP = A √ó [(1 + i)‚Åø - 1] / (i(1 + i)‚Åø) + G √ó [((1 + i)‚Åø - i√ón - 1) / (i¬≤(1 + i)‚Åø)]
                <br><br>

                <strong>Valor Futuro (VF) ‚Äî Gradiente Aritm√©tico:</strong><br>
                VF = A √ó [(1 + i)‚Åø - 1] / i + G √ó [((1 + i)‚Åø - i√ón - 1) / i¬≤]
            </div>

            <h4>Variables:</h4>
            <ul>
                <li><strong>A:</strong> Primer pago o flujo base</li>
                <li><strong>G:</strong> Incremento o decremento constante</li>
                <li><strong>n:</strong> N√∫mero de per√≠odos</li>
                <li><strong>i:</strong> Tasa de inter√©s por per√≠odo</li>
                <li><strong>VP / VF:</strong> Valor Presente o Futuro del gradiente</li>
            </ul>
        </div>
    </div>

    
    <form id="gradientesForm" class="form">
        <div class="input-group full-width">
            <label for="calcular">¬øQu√© deseas calcular?</label>
            <select id="calcular" name="calcular">
                <option value="aritmetico">Gradiente Aritm√©tico</option>
                <option value="geometrico">Gradiente Geom√©trico</option>
                <option value="series">Series Variables</option>
            </select>
        </div>

        <!-- Campos para Gradientes Aritm√©tico y Geom√©trico -->
        <div id="camposGradientes">
            <div class="input-row">
                <div class="input-group">
                    <label for="A">Primer pago (A):</label>
                    <input type="number" id="A" name="A" step="any">
                </div>

                <div class="input-group">
                    <label for="G">Gradiente (G):</label>
                    <input type="number" id="G" name="G" step="any">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="n">N√∫mero de per√≠odos (n):</label>
                    <input type="number" id="n" name="n">
                </div>

                <div class="input-group">
                    <label for="tasa">Tasa de inter√©s (i):</label>
                    <input type="number" id="tasa" name="tasa" step="0.01">
                </div>
            </div>
        </div>

        <!-- Campos para Series Variables -->
        <div id="camposSeries" class="hidden">
            <div class="input-row">
                <div class="input-group">
                    <label for="nSeries">N√∫mero de per√≠odos:</label>
                    <input type="number" id="nSeries" name="nSeries" min="1" >
                </div>
            
                <div class="input-group">
                    <label for="tasaSeries">Tasa de inter√©s (i):</label>
                    <input type="number" id="tasaSeries" name="tasaSeries" step="0.01">
                </div>
            </div>

            <button type="button" class="btn" id="generarFlujosBtn" style="margin-top: 20px;">
                üìã Generar campos de flujos </button>

            <div id="flujosContainer"></div>
        </div>

        <button type="button" class="btn" id="calcularBtn">Calcular</button>
</form>

    <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resultado:</h3>
            <div class="result-value" id="resultValue">‚Äî</div>
            <div class="result-detail" id="resultDetail">El resultado aparecer√° aqu√≠.</div>
        </div>
    </div>
</div>


    <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resultado:</h3>
            <div class="result-value" id="resultValue">‚Äî</div>
            <div class="result-detail" id="resultDetail">El resultado aparecer√° aqu√≠.</div>
        </div>
    </div>
</div>
<style>
    /* Estilos espec√≠ficos para flujos de caja */
    #flujosContainer {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    
    .flujo-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 8px;
        border-left: 3px solid #667eea;
        transition: all 0.3s ease;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .flujo-item:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateX(3px);
    }
    
    .flujo-item label {
        font-weight: 600;
        color: #667eea;
        min-width: 90px;
        margin: 0;
    }
    
    .flujo-item input {
        flex: 1;
        padding: 10px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .flujo-item input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    @media (max-width: 768px) {
        .flujo-item {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .flujo-item label {
            min-width: auto;
        }
        
        .flujo-item input {
            width: 100%;
        }
    }
</style>

<script>
    // Funci√≥n para toggle de teor√≠a
    document.getElementById('teoriaBtn').addEventListener('click', function() {
        const content = document.getElementById('teoriaContent');
        const icon = document.getElementById('teoriaIcon');
        
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    });
     // Cambiar campos seg√∫n tipo de c√°lculo
    document.getElementById('calcular').addEventListener('change', function() {
        const tipo = this.value;
        const camposGradientes = document.getElementById('camposGradientes');
        const camposSeries = document.getElementById('camposSeries');
        const flujosContainer = document.getElementById('flujosContainer');

        if (tipo === 'series') {
            // Mostrar solo campos de series variables
            camposGradientes.classList.add('hidden');
            camposSeries.classList.remove('hidden');
            // Limpiar flujos anteriores
            flujosContainer.innerHTML = '';
        } else {
            // Mostrar campos de gradientes aritm√©tico/geom√©trico
            camposGradientes.classList.remove('hidden');
            camposSeries.classList.add('hidden');
            // Limpiar flujos anteriores
            flujosContainer.innerHTML = '';
        }
    });


    // Generar campos de flujos para series variables
    document.getElementById('generarFlujosBtn').addEventListener('click', function() {
        const n = parseInt(document.getElementById('nSeries').value) || 0;
        const container = document.getElementById('flujosContainer');
        container.innerHTML = '';

        if (n <= 0) {
            alert('Por favor ingresa un n√∫mero de per√≠odos v√°lido (mayor a 0)');
            return;
        }

        if (n > 50) {
            alert('Por favor ingresa un n√∫mero de per√≠odos menor o igual a 50');
            return;
        }

        // Generar los campos din√°micamente
        for (let i = 1; i <= n; i++) {
            const flujoDiv = document.createElement('div');
            flujoDiv.className = 'flujo-item';
            flujoDiv.innerHTML = `
                <label>Per√≠odo ${i}:</label>
                <input type="number" class="flujo-input" data-periodo="${i}" step="any" placeholder="Ingresa el flujo del per√≠odo ${i}" required>
            `;
            container.appendChild(flujoDiv);
        }
    });


    // calcular....
document.getElementById('calcularBtn').addEventListener('click', async function() {
    const tipo = document.getElementById('calcular').value;
    const resultBox = document.getElementById('resultBox');
    const resultValue = document.getElementById('resultValue');
    const resultDetail = document.getElementById('resultDetail');

    let endpoint = "";
    let payload = {};

    // Gradiente aritm√©tico o geom√©trico
    if (tipo === 'aritmetico' || tipo === 'geometrico') {
        const A = parseFloat(document.getElementById('A').value) || 0;
        const G = parseFloat(document.getElementById('G').value) || 0;
        const n = parseFloat(document.getElementById('n').value) || 0;
        const i = parseFloat(document.getElementById('tasa').value) || 0;

        payload = { A: A, G: G, g: G, i: i, n: n, ct: [], t: 0 };

        if (tipo === 'aritmetico') {
            endpoint = "http://127.0.0.1:5000/calcular_Gradiente_aritmetico";
        } else {
            endpoint = "http://127.0.0.1:5000/calcular_Gradiente_geometrico";
        }
    }

    // Series variables
    else if (tipo === 'series') {
        const tasa = parseFloat(document.getElementById('tasaSeries').value) || 0;
        const n = parseInt(document.getElementById('nSeries').value) || 0;

        const flujos = Array.from(document.querySelectorAll('.flujo-input')).map(input => parseFloat(input.value) || 0);

        payload = { ct: flujos, i: tasa, n: n, t: 0, A: 0, g: 0, G: 0 };
        endpoint = "http://127.0.0.1:5000/calcular_series_gradiente";
    }

    try {
        const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Error en el c√°lculo");
        }

        const data = await response.json();
        resultBox.classList.remove('hidden');

        if (tipo === 'aritmetico') {
            resultValue.textContent = `Valor Futuro: ${data["Valor Futuro Gradiente Aritmetico"]}`;
            resultDetail.textContent = `Valor Actual: ${data["Valor Actual Gradiente Aritmetico"]}`;
        } 
        else if (tipo === 'geometrico') {
            resultValue.textContent = `Valor Futuro: ${data["Valor Futuro Gradiente Geometrico"]}`;
            resultDetail.textContent = `Valor Actual: ${data["Valor Actual Gradiente Geometrico"]}`;
        }
        else if (tipo === 'series') {
           // El backend devuelve un set {VA, VF} en ese orden fijo
            const valores = Array.from(data["Series Gradiente"]);
            const va = valores[0];
            const vf = valores[1];

            resultValue.textContent = "Series Variables";
            resultDetail.innerHTML = `
                <strong>Valor Presente (VP):</strong> ${va}<br>
                <strong>Valor Futuro (VF):</strong> ${vf}
            `;

        }

    } catch (error) {
        resultBox.classList.remove('hidden');
        resultValue.textContent = "‚ö†Ô∏è Error";
        resultDetail.textContent = error.message;
    }
});

</script>

{% endblock %}
