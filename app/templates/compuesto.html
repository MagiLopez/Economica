{% extends "base.html" %}

{% block title %}Inter√©s Compuesto{% endblock %}

{% block content %}

<div class="container">
    <!-- Header -->
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üìä Inter√©s Compuesto</h1>
        <span class="user-info">{{ username }}</span>
    </div>

<div class="teoria-section">
        <button class="teoria-toggle" type="button" id="teoriaBtn">
            <span id="teoriaIcon">‚ñ∂</span> Teor√≠a: ¬øQu√© es el Inter√©s Compuesto?
        </button>
        <div class="teoria-content" id="teoriaContent">
            <h3>üí° Conceptos B√°sicos</h3>
            <p><strong>El inter√©s compuesto</strong> es el inter√©s que se calcula sobre el capital inicial m√°s los intereses acumulados de per√≠odos anteriores. Es "inter√©s sobre inter√©s".</p>
            
            <h4>F√≥rmula Principal:</h4>
            <div class="formula-box">
                <strong>M = P √ó (1 + i)‚Åø</strong><br><br>
                <strong>Donde:</strong><br>
                ‚Ä¢ M = Monto final<br>
                ‚Ä¢ P = Capital inicial<br>
                ‚Ä¢ i = Tasa de inter√©s por per√≠odo (decimal)<br>
                ‚Ä¢ n = N√∫mero de per√≠odos
            </div>

            <h4>Variables:</h4>
            <ul>
                <li><strong>P (Capital):</strong> Dinero inicial invertido</li>
                <li><strong>i (Tasa):</strong> Porcentaje de inter√©s por per√≠odo</li>
                <li><strong>n (Tiempo):</strong> N√∫mero de per√≠odos de capitalizaci√≥n</li>
                <li><strong>M (Monto):</strong> Capital final acumulado</li>
                <li><strong>I (Inter√©s):</strong> Ganancia = M - P</li>
            </ul>

            <h4>üîÑ Diferencia con Inter√©s Simple:</h4>
            <div class="comparacion-box">
                <strong>Inter√©s Simple:</strong> El inter√©s se calcula solo sobre el capital inicial<br>
                <strong>Inter√©s Compuesto:</strong> El inter√©s se calcula sobre capital + intereses acumulados<br><br>
                <em>El inter√©s compuesto genera m√°s rendimiento a largo plazo üìà</em>
            </div>

           
        </div>
    </div>

    <p class="instruction">
        Completa <strong>3 campos</strong> y deja <strong>1 vac√≠o</strong>. 
        FINLY calcular√° autom√°ticamente el faltante.
    </p>

    <form class="form" id="compoundForm">
        <div class="input-row">
            <div class="input-group">
                <label>Capital Inicial (P):</label>
                <input id="capital" type="number" step="0.01" placeholder="Ej. 1000">
                <small>Dinero inicial a invertir</small>
            </div>

            <div class="input-group">
                <label>Tasa de Inter√©s (%):</label>
                <input id="tasa" type="number" step="0.01" placeholder="Ej. 5">
                <small>Porcentaje por periodo</small>
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label>Per√≠odo:</label>
                <div class="time-input">
                    <input id="periodo" type="number" min="1" placeholder="Tiempo">
                    
                </div>
                <small>Indica la duraci√≥n en meses y cu√°ntos pagos se hacen en total</small>
            </div>

            <div class="input-group">
                <label>Monto Final (M):</label>
                <input id="monto" type="number" step="0.01" placeholder="Ej. 1100">
                <small>Dinero total al final</small>
            </div>
        </div>

        <button type="submit" class="btn">üßÆ Calcular</button>
    </form>
    <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resultado:</h3>
            <div class="result-value" id="resultValue">0</div>
            <div class="result-detail" id="resultDetail"></div>
            <div class="result-detail" id="interestDetail"></div>
        </div>
    </div>

    <a href="/" class="btn-back">‚¨Ö Volver al Men√∫</a>
</div>

<script>
// Funci√≥n para toggle de teor√≠a
    document.getElementById('teoriaBtn').addEventListener('click', function() {
        const content = document.getElementById('teoriaContent');
        const icon = document.getElementById('teoriaIcon');
        
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    });

    const form = document.getElementById('compoundForm');
    const capitalInput = document.getElementById('capital');
    const tasaInput = document.getElementById('tasa');
    const tiempoMesesInput = document.getElementById('periodo');
    const montoInput = document.getElementById('monto');
    const resultBox = document.getElementById('resultBox');
    const resultValue = document.getElementById('resultValue');
    const resultDetail = document.getElementById('resultDetail');
    const interestDetail = document.getElementById('interestDetail');

    
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Considerar el tiempo como un solo campo (meses)
        const tiempoLleno = tiempoMesesInput.value;

        let filled = 0;
        if (capitalInput.value) filled++;
        if (tasaInput.value) filled++;
        if (tiempoLleno) filled++;
        if (montoInput.value) filled++;

        if (filled !== 3) {
            resultBox.classList.remove('hidden');
            resultValue.innerText = "‚ö† Validaci√≥n incorrecta";
            resultDetail.innerText = "Debes completar exactamente 3 campos y dejar 1 vac√≠o.";
            interestDetail.innerText = "";
            return;
        }

        // Mostrar estado de carga
        resultBox.classList.remove('hidden');
        resultValue.innerText = "üîÑ Calculando...";
        resultDetail.innerText = "Enviando datos al servidor...";
        interestDetail.innerText = "";

        try {
            // Preparar datos para enviar al backend
            const requestData = {
                Vp: capitalInput.value ? parseFloat(capitalInput.value) : 0,
                i: tasaInput.value ? parseFloat(tasaInput.value)  : 0, // Convertir porcentaje a decimal
                n: tiempoLleno ? parseFloat(tiempoLleno) : 0,
                Vf: montoInput.value ? parseFloat(montoInput.value) : 0
            };

            console.log('Enviando datos:', requestData);

            // Realizar petici√≥n al backend
            const response = await fetch(`http://127.0.0.1:5000/calcular_Interes_Compuesto`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error en el servidor');
            }

            const result = await response.json();
            console.log('Respuesta del servidor:', result);

            // Mostrar resultados
            resultValue.innerText = "‚úî C√°lculo completado";
            
            if (result.Vf !== undefined) {
                // Se calcul√≥ el valor futuro
                const valorFuturo = result.Vf.toFixed(2);
                const interes = (result.Vf - parseFloat(capitalInput.value)).toFixed(2);
                
                resultDetail.innerText = `Monto Final: $${valorFuturo}`;
                interestDetail.innerText = `Inter√©s Ganado: $${interes}`;
                
                // Llenar el campo calculado
                montoInput.value = valorFuturo;
                
            } else if (result.i !== undefined) {
                // Se calcul√≥ la tasa de inter√©s
                const tasaCalculada = result.i.toFixed(4);
                
                resultDetail.innerText = `Tasa de Inter√©s: ${tasaCalculada}%`;
                interestDetail.innerText = `Tasa anual requerida para alcanzar el objetivo`;
                
                // Llenar el campo calculado
                tasaInput.value = tasaCalculada;
                
            } else if (result.n !== undefined) {
                // Redondear el tiempo necesario en meses
                const tiempoCalculado = Math.round(result.n);

                resultDetail.innerText = `Tiempo Necesario: ${tiempoCalculado} meses`;
                
                // Mostrar solo en meses redondeados
                interestDetail.innerText = `Equivale a ${tiempoCalculado} meses`;

                // Llenar el campo calculado
                tiempoMesesInput.value = tiempoCalculado;
            }


        } catch (error) {
            console.error('Error:', error);
            resultValue.innerText = "‚ùå Error en el c√°lculo";
            resultDetail.innerText = `Error: ${error.message}`;
            interestDetail.innerText = "Por favor, verifica los datos ingresados.";
        }
    });

    // Funci√≥n para limpiar el formulario
    function limpiarFormulario() {
        capitalInput.value = '';
        tasaInput.value = '';
        tiempoMesesInput.value = '';
        montoInput.value = '';
        resultBox.classList.add('hidden');
    }

    // Opcional: Agregar bot√≥n de limpiar si no existe
    const limpiarBtn = document.getElementById('limpiarBtn');
    if (limpiarBtn) {
        limpiarBtn.addEventListener('click', limpiarFormulario);
    }
</script>
{% endblock %}
