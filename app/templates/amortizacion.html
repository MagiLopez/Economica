{% extends "base.html" %}

{% block title %}Amortizaci√≥n{% endblock %}

{% block content %}
<div class="container">
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üìä Amortizaci√≥n</h1>
        <span class="user-info">{{ username }}</span>
    </div>

    <!-- Secci√≥n de Teor√≠a Colapsable -->
    <div class="teoria-section">
        <button class="teoria-toggle" type="button" id="teoriaBtn">
            <span id="teoriaIcon">‚ñ∂</span> Teor√≠a: ¬øQu√© es la Amortizaci√≥n?
        </button>
        <div class="teoria-content" id="teoriaContent">
            <h3>üí° ¬øQu√© es la amortizaci√≥n?</h3>
            <p>La <strong>amortizaci√≥n</strong> consiste en el pago gradual de una deuda mediante
            <strong>cuotas peri√≥dicas</strong>. Cada cuota incluye una parte de
            <strong>capital</strong> (que reduce la deuda) y otra de
            <strong>intereses</strong> (que es el costo del pr√©stamo).
            </p>
            <h4>üìò M√©todos de amortizaci√≥n:</h4>

            <!-- SISTEMA FRANC√âS -->
            <div class="teoria-box" style="background-color:#f0f7ff; border-radius:10px; padding:15px; margin-bottom:15px;">
            <h4>üîπ Sistema Franc√©s</h4>
            <p>
                Cuotas <strong>constantes</strong>, amortizaci√≥n <strong>creciente</strong> e intereses
                <strong>decrecientes</strong>. Es el sistema m√°s com√∫n en pr√©stamos bancarios.
            </p>
            <p><strong>F√≥rmula:</strong></p>
            <p style="text-align:center;">
                <code>C = P √ó [i √ó (1 + i)‚Åø] / [(1 + i)‚Åø - 1]</code>
            </p>
            <p><strong>Donde:</strong><br>
                C = Cuota<br>
                P = Capital inicial<br>
                r = Tasa de inter√©s por per√≠odo<br>
                n = N√∫mero de per√≠odos
            </p>
            </div>

            <!-- SISTEMA ALEM√ÅN -->
            <div class="teoria-box" style="background-color:#f6f0ff; border-radius:10px; padding:15px; margin-bottom:15px;">
            <h4>üîπ Sistema Alem√°n</h4>
            <p>
                Amortizaci√≥n <strong>constante</strong> y cuotas <strong>decrecientes</strong>,
                ya que los intereses disminuyen a medida que se paga el capital.
            </p>
            <p><strong>F√≥rmula:</strong></p>
            <p style="text-align:center;">
                <code>A = P / n</code>
            </p>
            <p><strong>Donde:</strong><br>
                A = Amortizaci√≥n constante<br>
                P = Capital inicial<br>
                n = N√∫mero de per√≠odos
            </p>
            <p><strong>Cuota:</strong></p>
            <p style="text-align:center;">
                <code>C = A + (Saldo √ó r)</code>
            </p>
            </div>

            <!-- SISTEMA AMERICANO / INGL√âS -->
            <div class="teoria-box" style="background-color:#e9f5ff; border-radius:10px; padding:15px;">
            <h4>üîπ Sistema Americano</h4>
            <p>
                Durante el plazo del pr√©stamo solo se pagan los <strong>intereses peri√≥dicos</strong>,
                y el <strong>capital se cancela al final</strong> del per√≠odo.
            </p>
            <p><strong>F√≥rmula:</strong></p>
            <p style="text-align:center;">
                <code>I = P √ó r</code>
            </p>
            <p><strong>Donde:</strong><br>
                I = Inter√©s peri√≥dico<br>
                P = Capital inicial<br>
                r = Tasa de inter√©s por per√≠odo
            </p>
            <p><strong>En el √∫ltimo per√≠odo:</strong></p>
            <p style="text-align:center;">
                <code>Pago = I + P</code>
            </p>
            <p style="text-align:center; color:#555; font-size:0.9em;">
                (inter√©s + capital total)
            </p>
            </div>
            
        </div>
    </div>

    <p>Completa los campos requeridos para generar la tabla de amortizaci√≥n.</p>

    <form id="amortizacionForm">
        <div class="input-row">
            <div class="input-group">
                <label for="capital">Capital (P):</label>
                <input type="number" id="capital" name="capital" step="0.01" placeholder="10000">
                <small>Monto del pr√©stamo</small>
            </div>

            <div class="input-group">
                <label for="tasa">Tasa de inter√©s (i):</label>
                <input type="number" id="tasa" name="tasa" step="0.01" placeholder="5">
                <small>Por per√≠odo (%)</small>
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="n">N√∫mero de per√≠odos (n):</label>
                <input type="number" id="n" name="n" placeholder="12">
                <small>Cantidad de cuotas</small>
            </div>

            <div class="input-group full-width">
                <label for="tipoAmortizacion">Sistema de Amortizaci√≥n:</label>
                <select id="tipoAmortizacion" name="tipoAmortizacion">
                    <option value="frances">Sistema Franc√©s</option>
                    <option value="aleman">Sistema Alem√°n</option>
                    <option value="americano">Sistema Americano</option>
                </select>
            </div>
        </div>

        <button type="button" class="btn" id="calcularBtn">üìã Generar Tabla de Amortizaci√≥n</button>
    </form>

    <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resumen:</h3>
            <div class="result-value" id="resultValue">‚Äî</div>
            <div class="result-detail" id="resultDetail">El resultado aparecer√° aqu√≠.</div>
        </div>
    </div>
    
    <!-- Tabla de Amortizaci√≥n (FUERA del result-box) -->
    <div class="tabla-container hidden" id="tablaContainer" style="margin-top: 20px;">
        <table id="tablaAmortizacion" style="width: 100%; border-collapse: collapse;">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr>
                    <th style="padding: 12px; text-align: center;">Per√≠odo</th>
                    <th style="padding: 12px; text-align: center;">Cuota</th>
                    <th style="padding: 12px; text-align: center;">Inter√©s</th>
                    <th style="padding: 12px; text-align: center;">Amortizaci√≥n</th>
                    <th style="padding: 12px; text-align: center;">Saldo</th>
                </tr>
            </thead>
            <tbody id="tablaBody">
            </tbody>
        </table>
    </div>

</div>

<style>
   /* === ESTILOS BASE DE LA TABLA === */
#tablaAmortizacion {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

#tablaAmortizacion th, 
#tablaAmortizacion td {
    text-align: center;
    padding: 12px 10px;
    border-bottom: 1px solid #ddd;
}

#tablaAmortizacion th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9rem;
}

#tablaTotal {
    font-weight: bold;
    background: #e8eefc;
}

#tablaTotal td {
    border-top: 2px solid #667eea;
    border-bottom: none;
    font-size: 1.05rem;
}

/* === CONTENEDOR CON SCROLL HORIZONTAL === */
.tabla-container {
    width: 100%;
    overflow-x: auto;
    margin: 20px 0;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Estilo de la barra de scroll */
.tabla-container::-webkit-scrollbar {
    height: 8px;
}

.tabla-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.tabla-container::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 10px;
}

.tabla-container::-webkit-scrollbar-thumb:hover {
    background: #5568d3;
}

/* === RESPONSIVE PARA M√ìVILES === */
@media (max-width: 768px) {
    #tablaAmortizacion th,
    #tablaAmortizacion td {
        padding: 10px 8px;
        font-size: 0.85rem;
        white-space: nowrap; /* Evita que el texto se parta */
    }

    #tablaAmortizacion th {
        font-size: 0.8rem;
    }

    #tablaTotal td {
        font-size: 0.95rem;
    }
}

@media (max-width: 480px) {
    #tablaAmortizacion th,
    #tablaAmortizacion td {
        padding: 8px 6px;
        font-size: 0.75rem;
    }

    #tablaAmortizacion th {
        font-size: 0.7rem;
    }
}

/* === INDICADOR DE SCROLL (OPCIONAL) === */
.scroll-indicator {
    text-align: center;
    color: #667eea;
    font-size: 0.85rem;
    margin-top: 8px;
    font-style: italic;
    display: none;
}

@media (max-width: 768px) {
    .scroll-indicator {
        display: block;
    }
}
</style>

<script>
    // Mostrar/ocultar teor√≠a
    document.getElementById('teoriaBtn').addEventListener('click', function() {
        const content = document.getElementById('teoriaContent');
        const icon = document.getElementById('teoriaIcon');
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    });

    // Formatear n√∫meros como moneda
    function formatCurrency(valor) {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 2
        }).format(valor);
    }

    // Conexi√≥n con el backend FastAPI
    document.getElementById('calcularBtn').addEventListener('click', async function() {
        const resultBox = document.getElementById('resultBox');
        const resultValue = document.getElementById('resultValue');
        const resultDetail = document.getElementById('resultDetail');
        const tablaContainer = document.getElementById('tablaContainer');
        const tablaBody = document.getElementById('tablaBody');

        // Obtener valores del formulario
        const capital = parseFloat(document.getElementById('capital').value);
        const tasa = parseFloat(document.getElementById('tasa').value);
        const n = parseInt(document.getElementById('n').value);
        const tipoAmortizacion = document.getElementById('tipoAmortizacion').value;

        // Validaci√≥n
        if (isNaN(capital) || isNaN(tasa) || isNaN(n)) {
            alert('Por favor, completa todos los campos correctamente');
            return;
        }

        if (capital <= 0 || tasa <= 0 || n <= 0) {
            alert('Los valores deben ser mayores a cero');
            return;
        }

        // Determinar endpoint seg√∫n el tipo de amortizaci√≥n
        let endpoint = '';
        let tipoNombre = '';
        
        switch(tipoAmortizacion) {
            case 'frances':
                endpoint = 'http://127.0.0.1:5000/calcular_Amortizacion';
                tipoNombre = 'Sistema Franc√©s';
                break;
            case 'aleman':
                endpoint = 'http://127.0.0.1:5000/calcular_Amortizacion_Sistema_Aleman';
                tipoNombre = 'Sistema Alem√°n';
                break;
            case 'americano':
                endpoint = 'http://127.0.0.1:5000/calcular_Amortizacion_Sistema_Americano';
                tipoNombre = 'Sistema Americano';
                break;
        }

        try {
            // Enviar los datos al backend
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    p: capital,
                    i: tasa,
                    n: n
                })
            });

            if (!response.ok) throw new Error("Error al obtener la amortizaci√≥n");

            const data = await response.json();

            // Mostrar resultados
            resultBox.classList.remove('hidden');
            resultValue.textContent = tipoNombre;
            
            // Limpiar tabla anterior
            tablaBody.innerHTML = '';

            // Procesar seg√∫n el tipo de sistema
            // Obtener la tabla seg√∫n el tipo de sistema
            const tabla = data.tabla || data;
            
            resultDetail.innerHTML = `
                <strong>Capital:</strong> ${formatCurrency(capital)}<br>
                <strong>Tasa:</strong> ${tasa}% por per√≠odo<br>
                <strong>Per√≠odos:</strong> ${n}
            `;

            // Variables para totales
            let totalCuota = 0;
            let totalInteres = 0;
            let totalAmortizacion = 0;

            // Rellenar tabla con los datos del backend (todos los sistemas)
            tabla.forEach((fila) => {
                const periodo = fila[0];
                const cuota = parseFloat(fila[1]) || 0;
                const interes = parseFloat(fila[2]) || 0;
                const amortizacion = parseFloat(fila[3]) || 0;
                const saldo = parseFloat(fila[4]) || 0;

                // Saltar el per√≠odo 0 si existe
                if (periodo === 0) return;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td style="text-align: center;">${periodo}</td>
                    <td style="text-align: center;">${formatCurrency(cuota)}</td>
                    <td style="text-align: center;">${formatCurrency(interes)}</td>
                    <td style="text-align: center;">${formatCurrency(amortizacion)}</td>
                    <td style="text-align: center;">${formatCurrency(saldo)}</td>
                `;
                
                tablaBody.appendChild(tr);

                // Acumular totales
                totalCuota += cuota;
                totalInteres += interes;
                totalAmortizacion += amortizacion;
            });

            // Fila de totales
            const totalRow = document.createElement("tr");
            totalRow.id = "tablaTotal";
            totalRow.innerHTML = `
                <td style="text-align: center;"><strong>TOTALES</strong></td>
                <td style="text-align: center;"><strong>${formatCurrency(totalCuota)}</strong></td>
                <td style="text-align: center;"><strong>${formatCurrency(totalInteres)}</strong></td>
                <td style="text-align: center;"><strong>${formatCurrency(totalAmortizacion)}</strong></td>
                <td style="text-align: center;"><strong>‚Äî</strong></td>
            `;
            tablaBody.appendChild(totalRow);

            tablaContainer.classList.remove('hidden');

        } catch (error) {
            console.error("Error:", error);
            alert("Ocurri√≥ un error al conectar con el servidor: " + error.message);
        }
    });
</script>
 
{% endblock %}