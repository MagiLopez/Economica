{% extends "base.html" %}

{% block title %}Tasa de Retorno{% endblock %}

{% block content %}
<div class="container">
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üíπ Tasa de Retorno</h1>
        <span class="user-info">{{ username }}</span>
    </div>

    <!-- Secci√≥n de Teor√≠a Colapsable -->
    <div class="teoria-section">
        <button class="teoria-toggle" type="button" id="teoriaBtn">
            <span id="teoriaIcon">‚ñ∂</span> Teor√≠a: ¬øQu√© es la Tasa de Retorno?
        </button>
        <div class="teoria-content" id="teoriaContent">
            <h3>üí° Conceptos B√°sicos</h3>
            <p>La <strong>Tasa de Retorno</strong> (tambi√©n llamada Tasa Interna de Retorno - TIR) es la tasa de inter√©s que hace que el valor presente neto (VPN) de todos los flujos de efectivo de una inversi√≥n sea igual a cero.  
               Es una medida clave para evaluar la rentabilidad de un proyecto o inversi√≥n.</p>

            <h4>Tipos de An√°lisis:</h4>
            <div class="tipo-box">
                <strong>üîπ TIR (Tasa Interna de Retorno):</strong> Tasa que iguala el VPN a cero.<br>
                <strong>üîπ VPN (Valor Presente Neto):</strong> Diferencia entre el valor presente de ingresos y egresos.<br>
                <strong>üîπ Per√≠odo de Recuperaci√≥n:</strong> Tiempo necesario para recuperar la inversi√≥n inicial.
            </div>

            <h4>F√≥rmulas Principales:</h4>
            <div class="formula-box">
                <strong>Valor Presente Neto (VPN):</strong><br>
                VPN = Œ£ [Flujo_t / (1 + i)^t] - Inversi√≥n Inicial<br><br>

                <strong>Tasa Interna de Retorno (TIR):</strong><br>
                0 = Œ£ [Flujo_t / (1 + TIR)^t] - Inversi√≥n Inicial<br><br>

                <strong>Criterio de Decisi√≥n:</strong><br>
                ‚Ä¢ Si TIR > Tasa de descuento ‚Üí Aceptar proyecto<br>
                ‚Ä¢ Si TIR < Tasa de descuento ‚Üí Rechazar proyecto<br>
                ‚Ä¢ Si VPN > 0 ‚Üí Proyecto rentable
            </div>

            <h4>Variables:</h4>
            <ul>
                <li><strong>Inversi√≥n Inicial:</strong> Capital invertido al inicio (flujo negativo)</li>
                <li><strong>Flujos de Efectivo:</strong> Ingresos o egresos en cada per√≠odo</li>
                <li><strong>i (Tasa de descuento):</strong> Tasa m√≠nima aceptable de retorno</li>
                <li><strong>n (Per√≠odos):</strong> Duraci√≥n del proyecto</li>
                <li><strong>TIR:</strong> Tasa que hace VPN = 0</li>
            </ul>
        </div>
    </div>

    <p>Ingresa la inversi√≥n inicial y los flujos de efectivo por per√≠odo para calcular la TIR y el VPN. El c√°lculo se realizar√° cuando est√© disponible la conexi√≥n.</p>

    <form id="tasaRetornoForm">
        <div class="input-row">
            <div class="input-group">
                <label for="inversionInicial">Inversi√≥n Inicial:</label>
                <input type="number" id="inversionInicial" name="inversionInicial" step="0.01">
                <small>Monto invertido (positivo)</small>
            </div>

            <div class="input-group">
                <label for="tasaDescuento">Tasa de Descuento (%):</label>
                <input type="number" id="tasaDescuento" name="tasaDescuento" step="0.01">
                <small>Para c√°lculo del VPN</small>
            </div>
        </div>

        <div class="input-group full-width">
            <label for="numPeriodos">N√∫mero de Per√≠odos:</label>
            <input type="number" id="numPeriodos" name="numPeriodos" min="1" max="20">
            <small>Cantidad de flujos de efectivo</small>
        </div>

        <button type="button" class="btn" id="generarFlujosBtn">‚ûï Generar Campos de Flujos</button>

        <!-- Contenedor din√°mico para flujos de efectivo -->
        <div id="flujosContainer" class="flujos-container hidden">
            <h4>üí∞ Flujos de Efectivo por Per√≠odo</h4>
            <div id="flujosInputs"></div>
        </div>

        <button type="button" class="btn hidden" id="calcularBtn">üìä Calcular TIR y VPN</button>
    </form>

    <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üìà Resultados del An√°lisis:</h3>
            <div class="result-grid">
                <div class="result-item">
                    <span class="result-label">TIR (Tasa Interna de Retorno):</span>
                    <div class="result-value" id="tirValue">‚Äî</div>
                </div>
                <div class="result-item">
                    <span class="result-label">VPN (Valor Presente Neto):</span>
                    <div class="result-value" id="vpnValue">‚Äî</div>
                </div>
            </div>
            <div class="result-detail" id="resultDetail">Los resultados aparecer√°n aqu√≠.</div>
        </div>
    </div>

    <!-- Tabla de Flujos -->
    <div class="tabla-flujos hidden" id="tablaFlujos">
        <h3>üìã An√°lisis de Flujos de Efectivo</h3>
        <div class="table-responsive">
            <table id="tablaFlujosContent">
                <thead>
                    <tr>
                        <th>Per√≠odo</th>
                        <th>Flujo de Efectivo</th>
                        <th>Flujo Descontado</th>
                        <th>Flujo Acumulado</th>
                    </tr>
                </thead>
                <tbody id="tablaFlujosBody">
                    <!-- Las filas se generar√°n din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .flujos-container {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .flujos-container h4 {
        margin-bottom: 1rem;
        color: #2c3e50;
    }

    #flujosInputs {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }

    .flujo-input-group {
        display: flex;
        flex-direction: column;
    }

    .flujo-input-group label {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 0.3rem;
        font-weight: 500;
    }

    .flujo-input-group input {
        padding: 0.6rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    .flujo-input-group input:focus {
        border-color: #667eea;
        outline: none;
    }

    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    .result-item {
        text-align: center;
    }

    .result-label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .tabla-flujos {
        margin-top: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .tabla-flujos h3 {
        margin-bottom: 1rem;
        color: #2c3e50;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .tabla-flujos table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .tabla-flujos th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem;
        text-align: center;
        font-weight: 600;
    }

    .tabla-flujos td {
        padding: 0.75rem;
        text-align: right;
        border-bottom: 1px solid #e0e0e0;
    }

    .tabla-flujos td:first-child {
        text-align: center;
        font-weight: 600;
        color: #667eea;
    }

    .tabla-flujos tbody tr:hover {
        background: #f8f9fa;
    }

    .tabla-flujos tbody tr:last-child {
        background: #f0f4ff;
        font-weight: 600;
    }
</style>

<script>
    // Mostrar/ocultar la teor√≠a
    document.getElementById('teoriaBtn').addEventListener('click', function() {
        const content = document.getElementById('teoriaContent');
        const icon = document.getElementById('teoriaIcon');
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    });

    // Generar campos de flujos din√°micamente
    document.getElementById('generarFlujosBtn').addEventListener('click', function() {
        const numPeriodos = parseInt(document.getElementById('numPeriodos').value);
        
        if (isNaN(numPeriodos) || numPeriodos < 1 || numPeriodos > 20) {
            alert('Por favor, ingresa un n√∫mero v√°lido de per√≠odos (1-20)');
            return;
        }

        const flujosContainer = document.getElementById('flujosContainer');
        const flujosInputs = document.getElementById('flujosInputs');
        const calcularBtn = document.getElementById('calcularBtn');
        
        // Limpiar inputs anteriores
        flujosInputs.innerHTML = '';
        
        // Generar inputs para cada per√≠odo
        for (let i = 1; i <= numPeriodos; i++) {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'flujo-input-group';
            inputGroup.innerHTML = `
                <label for="flujo${i}">Per√≠odo ${i}:</label>
                <input type="number" id="flujo${i}" name="flujo${i}" step="0.01" placeholder="$0.00">
            `;
            flujosInputs.appendChild(inputGroup);
        }
        
        // Mostrar contenedor y bot√≥n de calcular
        flujosContainer.classList.remove('hidden');
        calcularBtn.classList.remove('hidden');
    });

    // ‚úÖ Conexi√≥n con el backend FastAPI
    document.getElementById('calcularBtn').addEventListener('click', async function() {
        const inversionInicial = parseFloat(document.getElementById('inversionInicial').value);
        const numPeriodos = parseInt(document.getElementById('numPeriodos').value);

        // Validar campos
        if (isNaN(inversionInicial) || isNaN(numPeriodos) || numPeriodos < 1) {
            alert('Por favor, ingresa todos los valores correctamente');
            return;
        }

        // Obtener flujos de efectivo
        let flujos = [-inversionInicial]; // inversi√≥n inicial negativa
        for (let i = 1; i <= numPeriodos; i++) {
            const flujo = parseFloat(document.getElementById(`flujo${i}`).value);
            if (isNaN(flujo)) {
                alert(`Por favor, ingresa un valor v√°lido para el per√≠odo ${i}`);
                return;
            }
            flujos.push(flujo);
        }

        // Enviar datos al backend
        try {
            const response = await fetch("http://127.0.0.1:5000/calcular_TIR", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ flujo_de_caja: flujos })
            });

            if (!response.ok) {
                throw new Error("Error al calcular la TIR");
            }

            const data = await response.json();

            // Mostrar resultado
            const resultBox = document.getElementById('resultBox');
            const tirValue = document.getElementById('tirValue');
            tirValue.textContent = data.TIR + " %";

            resultBox.classList.remove('hidden');
            document.getElementById('resultDetail').textContent = "C√°lculo exitoso desde el backend.";

        } catch (error) {
            alert("Hubo un problema con la conexi√≥n al servidor: " + error.message);
        }
    });
</script>



{% endblock %}