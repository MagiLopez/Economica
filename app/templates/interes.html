{% extends "base.html" %}

{% block title %}Tasa de Inter√©s{% endblock %}

{% block content %}
<div class="container">
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üí≤ Tasa de Inter√©s</h1>
        <span class="user-info">{{ username }}</span>
    </div>
    
 <!-- Secci√≥n de Teor√≠a Colapsable -->
    <div class="teoria-section">
        <button class="teoria-toggle" type="button" id="teoriaBtn">
            <span id="teoriaIcon">‚ñ∂</span> Teor√≠a: ¬øQu√© es la Tasa de Inter√©s?
        </button>
        <div class="teoria-content" id="teoriaContent">
            <h3>üí° Conceptos B√°sicos</h3>
            <p><strong>La tasa de inter√©s</strong> es el porcentaje que se paga o cobra por el uso del dinero durante un per√≠odo determinado. Es el "precio del dinero" en el tiempo.</p>
            
            <h4>Tipos de Tasas de Inter√©s:</h4>
            <div class="tipo-box">
                <strong>üîπ Tasa Nominal:</strong> Es la tasa anual que se declara sin considerar la capitalizaci√≥n.<br>
                <strong>üîπ Tasa Efectiva:</strong> Es la tasa real que considera la capitalizaci√≥n en per√≠odos menores.<br>
                <strong>üîπ Tasa Peri√≥dica:</strong> Tasa aplicable a cada per√≠odo (mensual, trimestral, etc.)
            </div>

            <h4>Conversi√≥n de Tasas:</h4>
            <div class="formula-box">
                <strong>Tasa Peri√≥dica (mensual):</strong><br>
                i_mensual = i_anual / 12<br><br>
                <strong>Tasa Efectiva Anual (TEA):</strong><br>
                TEA = (1 + i_peri√≥dica)‚Åø - 1<br><br>
                <strong>Valor Futuro:</strong><br>
                VF = VP √ó (1 + i)‚Åø
            </div>

            <h4>Variables:</h4>
            <ul>
                <li><strong>VP (Valor Presente):</strong> Capital inicial o actual</li>
                <li><strong>VF (Valor Futuro):</strong> Monto acumulado despu√©s del tiempo</li>
                <li><strong>i (Tasa de inter√©s):</strong> Porcentaje de rendimiento o costo</li>
                <li><strong>n (Tiempo):</strong> N√∫mero de per√≠odos (meses, a√±os, etc.)</li>
            </ul>

            
        </div>
    </div>
    
    <p>Completa exactamente <strong>los 3 campos</strong>  El c√°lculo se realizar√° en el servidor.</p>

    <form id="interesForm" method="post">
        <div class="input-row">
            <div class="input-group">
                <label for="capital">Capital (C):</label>
                <input type="number" id="capital" name="capital">
            </div>

        

        </div>
        <div class="input-row">
            <div class="input-group">
                <label for="tiempo">Tiempo (meses):</label>
                <input type="number" id="tiempo" name="tiempo">
            </div>

            <div class="input-group">
                <label for="tasa">Tasa de Inter√©s (i):</label>
                <input type="number" id="tasa" step="0.01">
                <small> </small>
            </div>
        </div>
        

        <button type="submit" class="btn" id="calcularBtn"> Calcular</button>
    </form>

   <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resultado:</h3>
            <div class="result-value" id="resultValue">0</div>
            <div class="result-detail" id="resultDetail"></div>
            <div class="result-detail" id="interestDetail"></div>
        </div>
    </div>
</div>

<script>

    // Funci√≥n para toggle de teor√≠a
    document.getElementById('teoriaBtn').addEventListener('click', function() {
        const content = document.getElementById('teoriaContent');
        const icon = document.getElementById('teoriaIcon');
        
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    });
    const form = document.getElementById('interesForm');
    const capitalInput = document.getElementById('capital');
    const tiempoInput = document.getElementById('tiempo');
    const tasaInput = document.getElementById('tasa');
    const resultBox = document.getElementById('resultBox');
    const resultValue = document.getElementById('resultValue');
    const resultDetail = document.getElementById('resultDetail');
    const interestDetail = document.getElementById('interestDetail');

    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        console.log("Interceptado, no se hace GET");

        // Validar que se ingresen las 3 variables
        if (!capitalInput.value || !tiempoInput.value || !tasaInput.value) {
            resultBox.classList.remove('hidden');
            resultValue.innerText = "‚ö† Campos requeridos";
            resultDetail.innerText = "Debes completar los 3 campos: Capital, Tiempo y Tasa de Inter√©s.";
            interestDetail.innerText = "";
            return;
        }

        // Mostrar loading
        resultBox.classList.remove('hidden');
        resultValue.innerText = "‚è≥ Calculando...";
        resultDetail.innerText = "Enviando datos al servidor...";
        interestDetail.innerText = "";

        try {
            // Preparar datos - ahora con los nombres correctos del modelo backend
            const requestData = {
                Vp: parseFloat(capitalInput.value),           // Capital -> Vp
                n: parseFloat(tiempoInput.value),             // Tiempo -> n  
                i: parseFloat(tasaInput.value) / 100          // Tasa % -> decimal
            };

            console.log('Enviando datos:', requestData);

            // Cambiar la URL al puerto correcto (8000 para FastAPI)
            const response = await fetch('http://127.0.0.1:5000/calcular_Tasa_de_Interes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Error del servidor: ${response.status}`);
            }

            const data = await response.json();
            console.log('Respuesta del servidor:', data);

            // Mostrar resultados usando solo los elementos que existen en tu HTML
            resultValue.innerText = "‚úÖ C√°lculo completado";
            resultDetail.innerText = `üìä Tasa de inter√©s mensual: ${data.i_mensual.toFixed(4)}%`;
            interestDetail.innerText = `üí∞ Valor futuro mensual: $${data.Vf_mensual.toFixed(2)} | Valor futuro total: $${data.Vf.toFixed(2)}`;

        } catch (error) {
            console.error('Error completo:', error);
            resultValue.innerText = "‚ùå Error en el c√°lculo";
            resultDetail.innerText = `Error: ${error.message}`;
            interestDetail.innerText = "Verifica que el servidor est√© ejecut√°ndose y los datos sean v√°lidos.";
        }
    });

    // Funci√≥n para limpiar el formulario
    function limpiarFormulario() {
        capitalInput.value = '';
        tiempoInput.value = '';
        tasaInput.value = '';
        resultBox.classList.add('hidden');
    }

    // Agregar bot√≥n de limpiar si existe
    const limpiarBtn = document.getElementById('limpiarBtn');
    if (limpiarBtn) {
        limpiarBtn.addEventListener('click', limpiarFormulario);
    }
</script>


{% endblock %}
